<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Travel Companion</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Pacifico&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Fallback */
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url('https://images.unsplash.com/photo-1598091383021-15d2c10712b9?q=80&w=2940&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            z-index: -1;
            filter: blur(3px);
            animation: fadeInBody 1s ease-in-out forwards;
        }

        @keyframes fadeInBody {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .auth-card {
            background-image: linear-gradient(rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.95)), url('https://images.unsplash.com/photo-1524231757912-21f4fe3a7207?q=80&w=2843&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            backdrop-filter: blur(10px);
            border-radius: 0.75rem;
            border: none;
            border-top: 4px solid #f39c12;
            max-width: 450px;
            width: 100%;
            position: relative; /* For doodle positioning */
        }

        .btn-primary, .btn-primary:hover, .btn-primary:active, .btn-primary:focus {
            background-color: #f39c12;
            border-color: #f39c12;
            box-shadow: none;
        }

        .btn-primary:hover {
            background-color: #e67e22;
            border-color: #e67e22;
        }

        .btn-outline-primary {
             border-color: #f39c12;
             color: #f39c12;
        }

        .btn-outline-primary:hover {
            background-color: #f39c12;
            border-color: #f39c12;
            color: #fff;
        }
        
        .btn-hover-effect {
            transition: transform 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease;
        }
        .btn-hover-effect:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }
        
        .brand-font {
            font-family: 'Pacifico', cursive;
            color: #e67e22;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
        }
        
        /* Typewriter animation for "Namaste India" */
        .typewriter h1 {
            overflow: hidden;
            border-right: .15em solid orange;
            white-space: nowrap;
            margin: 0 auto;
            letter-spacing: .10em;
            animation: 
                typing 3.5s steps(30, end),
                blink-caret .75s step-end infinite;
        }

        @keyframes typing {
            from { width: 0 }
            to { width: 100% }
        }
        @keyframes blink-caret {
            from, to { border-color: transparent }
            50% { border-color: orange; }
        }


        .namaste-img {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-top: -75px;
        }

        .form-control:focus {
            border-color: #f39c12;
            box-shadow: 0 0 0 0.25rem rgba(243, 156, 18, 0.25);
        }
        
        a {
            color: #f39c12;
        }
        a:hover {
            color: #e67e22;
        }


        /* Doodle styles (omitted for brevity) */

    </style>
</head>
<body>

    <main class="container p-3">
        <div class="row justify-content-center">
            <div class="col-12 col-md-8 col-lg-6">
                <div class="card auth-card shadow-lg border-0 overflow-hidden">
                    <!-- Doodles (omitted for brevity) -->

                    <div class="card-header bg-transparent border-0 text-center pt-5">
                         <img src="https://images.unsplash.com/photo-1595884932639-38622c719943?q=80&w=2787&auto=format&fit=crop" 
                              alt="Woman in Saree saying Namaste" 
                              class="namaste-img"
                              onerror="this.onerror=null; this.src='https://placehold.co/150x150/f39c12/ffffff?text=Namaste';">
                    </div>
                    <div class="card-body p-4 p-md-5">
                        <div class="text-center mb-4">
                            <div class="typewriter mx-auto">
                                <h1 id="formTitle" class="h2 brand-font">Namaste India</h1>
                            </div>
                            <p id="welcomeMessage" class="text-muted mt-2">Welcome! Please sign in to continue.</p>
                        </div>

                        <!-- API Message Area -->
                        <div id="apiMessage" class="alert d-none" role="alert"></div>

                        <!-- Login Form -->
                        <form id="loginForm">
                            <div class="mb-3">
                                <label for="loginEmail" class="form-label">Email address</label>
                                <input type="email" class="form-control" id="loginEmail" required>
                            </div>
                            <div class="mb-3">
                                <label for="loginPassword" class="form-label">Password</label>
                                <input type="password" class="form-control" id="loginPassword" required>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-hover-effect">Login</button>
                            </div>
                        </form>

                        <!-- Signup Form -->
                        <form id="signupForm" class="d-none">
                             <div class="mb-3">
                                <label for="signupUsername" class="form-label">Username</label>
                                <input type="text" class="form-control" id="signupUsername" required>
                            </div>
                            <div class="mb-3">
                                <label for="signupEmail" class="form-label">Email address</label>
                                <input type="email" class="form-control" id="signupEmail" required>
                            </div>
                            <div class="mb-3">
                                <label for="signupPhone" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="signupPhone" required>
                            </div>
                             <div class="mb-3">
                                <label for="signupPassport" class="form-label">Passport / Aadhaar No.</label>
                                <input type="text" class="form-control" id="signupPassport" required>
                            </div>
                            <div class="mb-3">
                                <label for="signupPassword" class="form-label">Password</label>
                                <input type="password" class="form-control" id="signupPassword" required>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-hover-effect">Create Account</button>
                            </div>
                        </form>
                        
                        <!-- Email OTP Form -->
                        <form id="emailOtpForm" class="d-none">
                            <div class="mb-3 text-center">
                                <label for="emailOtp" class="form-label">Enter Email OTP</label>
                                <input type="text" class="form-control text-center" id="emailOtp" maxlength="6" required>
                                <div class="form-text">A 6-digit code was sent to your email.</div>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-hover-effect">Verify Email</button>
                            </div>
                        </form>
                        
                        <!-- Phone OTP Form -->
                        <form id="phoneOtpForm" class="d-none">
                            <div class="mb-3 text-center">
                                <label for="phoneOtp" class="form-label">Enter Phone OTP</label>
                                <input type="text" class="form-control text-center" id="phoneOtp" maxlength="6" required>
                                <div class="form-text">A 6-digit code was sent to your phone.</div>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-hover-effect">Verify Phone & Finish</button>
                            </div>
                        </form>

                        <!-- Success View -->
                        <div id="successView" class="d-none text-center">
                            <h3 class="text-success">Registration Complete!</h3>
                            <p>You have been successfully logged in.</p>
                        </div>
                        
                        <div class="text-center mt-3">
                             <button type="button" class="btn btn-outline-primary btn-sm btn-hover-effect" id="getTipBtn">
                                 âœ¨ Get a Travel Tip!
                             </button>
                        </div>

                        <div id="toggleContainer" class="text-center mt-4">
                            <p id="toggleText" class="mb-0">
                                Don't have an account? 
                                <a href="#" id="showSignup" class="fw-bold text-decoration-none">Sign Up</a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Travel Tip Modal (omitted for brevity) -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const views = {
                login: document.getElementById('loginForm'),
                signup: document.getElementById('signupForm'),
                emailOtp: document.getElementById('emailOtpForm'),
                phoneOtp: document.getElementById('phoneOtpForm'),
                success: document.getElementById('successView')
            };

            const formTitle = document.getElementById('formTitle');
            const welcomeMessage = document.getElementById('welcomeMessage');
            const toggleText = document.getElementById('toggleText');
            const toggleContainer = document.getElementById('toggleContainer');
            const getTipBtn = document.getElementById('getTipBtn');
            const apiMessage = document.getElementById('apiMessage');

            let userEmail = '';
            let userPhone = '';
            
            // --- Helper Functions ---

            // Function to get CSRF token from cookies
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrftoken = getCookie('csrftoken');


            const showView = (viewName) => {
                Object.values(views).forEach(view => view.classList.add('d-none'));
                views[viewName].classList.remove('d-none');
                updateTitles(viewName);
            };

            const showApiMessage = (message, isError = true) => {
                apiMessage.textContent = message;
                apiMessage.classList.remove('d-none', 'alert-success', 'alert-danger');
                apiMessage.classList.add(isError ? 'alert-danger' : 'alert-success');
            };

            const hideApiMessage = () => {
                apiMessage.classList.add('d-none');
            };

            const updateTitles = (viewName) => {
                 toggleContainer.classList.remove('d-none');
                 getTipBtn.classList.remove('d-none');

                switch(viewName) {
                    case 'signup':
                        welcomeMessage.textContent = 'Create an account to get started.';
                        toggleText.innerHTML = 'Already have an account? <a href="#" id="showLogin" class="fw-bold text-decoration-none">Login</a>';
                        document.getElementById('showLogin').addEventListener('click', (e) => { e.preventDefault(); showView('login'); });
                        break;
                    case 'emailOtp':
                        formTitle.textContent = "Verify Your Email";
                        welcomeMessage.textContent = `Enter the code sent to ${userEmail}`;
                        toggleContainer.classList.add('d-none');
                        getTipBtn.classList.add('d-none');
                        break;
                    case 'phoneOtp':
                        formTitle.textContent = "Verify Your Phone";
                        welcomeMessage.textContent = `Last step! Enter the code sent to ${userPhone}`;
                        toggleContainer.classList.add('d-none');
                        getTipBtn.classList.add('d-none');
                        break;
                     case 'success':
                        formTitle.textContent = "Welcome!";
                        welcomeMessage.textContent = `You are ready to explore safely.`;
                        toggleContainer.classList.add('d-none');
                        getTipBtn.classList.add('d-none');
                        break;
                    default: // login
                        formTitle.textContent = "Namaste India";
                        welcomeMessage.textContent = 'Welcome! Please sign in to continue.';
                        toggleText.innerHTML = 'Don\'t have an account? <a href="#" id="showSignup" class="fw-bold text-decoration-none">Sign Up</a>';
                        document.getElementById('showSignup').addEventListener('click', (e) => { e.preventDefault(); showView('signup'); });
                        break;
                }
            };
            
            // --- Event Listeners ---
            document.getElementById('showSignup').addEventListener('click', (e) => { e.preventDefault(); showView('signup'); });

            // SIGNUP
            views.signup.addEventListener('submit', async (e) => {
                e.preventDefault();
                hideApiMessage();
                const formData = {
                    username: document.getElementById('signupUsername').value,
                    email: document.getElementById('signupEmail').value,
                    phone: document.getElementById('signupPhone').value,
                    passport_aadhaar: document.getElementById('signupPassport').value,
                    password: document.getElementById('signupPassword').value,
                };
                userEmail = formData.email;
                userPhone = formData.phone;

                try {
                    const response = await fetch('/api/v1/auth/register/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify(formData)
                    });
                    const data = await response.json();
                    if (!response.ok) throw data;
                    
                    showApiMessage(data.message, false);
                    showView('emailOtp');
                } catch (error) {
                    let errorMessage = 'Registration failed. Please check your inputs.';
                    if (typeof error === 'object' && error !== null) {
                        errorMessage = Object.entries(error).map(([field, messages]) => {
                            return `${field.replace('_', ' ')}: ${messages.join(' ')}`;
                        }).join(' ');
                    }
                    showApiMessage(errorMessage);
                }
            });

            // EMAIL OTP VERIFY
            views.emailOtp.addEventListener('submit', async (e) => {
                e.preventDefault();
                hideApiMessage();
                const formData = {
                    email: userEmail,
                    otp: document.getElementById('emailOtp').value,
                };

                try {
                    const response = await fetch('/api/v1/auth/verify-email/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify(formData)
                    });
                    const data = await response.json();
                    if (!response.ok) throw data;
                    
                    showApiMessage(data.message, false);
                    showView('phoneOtp');
                } catch (error) {
                    showApiMessage(error.error || 'Email verification failed.');
                }
            });
            
            // PHONE OTP VERIFY
            views.phoneOtp.addEventListener('submit', async (e) => {
                e.preventDefault();
                hideApiMessage();
                const formData = {
                    phone: userPhone,
                    otp: document.getElementById('phoneOtp').value,
                };

                try {
                    const response = await fetch('/api/v1/auth/verify-phone/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify(formData)
                    });
                    const data = await response.json();
                    if (!response.ok) throw data;

                    localStorage.setItem('authToken', data.token);
                    showView('success');
                } catch (error) {
                     showApiMessage(error.error || 'Phone verification failed.');
                }
            });

            // LOGIN
            views.login.addEventListener('submit', async (e) => {
                e.preventDefault();
                hideApiMessage();
                const formData = {
                    email: document.getElementById('loginEmail').value,
                    password: document.getElementById('loginPassword').value,
                };

                try {
                    const response = await fetch('/api/v1/auth/login/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify(formData)
                    });
                    const data = await response.json();
                    if (!response.ok) throw data;

                    localStorage.setItem('authToken', data.token);
                    showView('success');
                    apiMessage.classList.add('d-none');
                    welcomeMessage.textContent = "Login Successful! Welcome back.";

                } catch (error) {
                    showApiMessage(error.error || 'Login failed. Please check your credentials.');
                }
            });

            // Gemini API Feature (omitted for brevity)
        });
    </script>
</body>
</html>




